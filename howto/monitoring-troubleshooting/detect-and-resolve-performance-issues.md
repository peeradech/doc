# เกริ่นนำ
ไม่ว่า Application ใดที่ใช้งานสามารถพบปัญหาเรื่อง **Performance** ได้เช่นกัน ในเอกสารนี้จะอธิบายปัญหาต่าง ๆ ต้นเหตุของปัญหา และวิธีการแก้ปัญหาเหล่านั้น

Flow ด้านล่าง design เหมือนกับ Microflow ให้เห็นถึงวิธีการหาปัญหา และวิธีการแก้ปัญหา ซึ่งจะยึดแนวทางนี้

![file](/uploads/inline_files/image-1589875136858.png)

# Issues
ปัญหาเรื่อง Performance เป็นเรื่องปกติที่ผู้ใช้งานจะพบ ซึ่งมีความเป็นไปได้ไม่ทางใดก็ทางหนึ่ง ไม่ว่าจะเป็นการทำงานนานกว่าจะสำเร็จ (หน้าจอแสดงผลช้าหรือไม่ตอบสนอง) หรือโหลดหน้าจอช้ามาก ทั้ง 2 กรณีใช้เวลาในการ process นาน หรือใช้เวลามากในการจบแต่ละขั้นตอน ถ้าคุณต้องหาให้ได้ว่าปัญหาเกิดจากจุดไหน และโฟกัสไปจุดที่เกิดปัญหาเพื่อจะทำให้ Optimize ที่สุด

สิ่งแรกต้องบอกให้ได้ว่าปัญหาเกิดจาก UI เป็นหลัก หรือ Microflow เป็นหลัก

- ถ้าหน้าเว็บโหลดช้าในครั้งแรก หรือไม่มีการตอบสนองหลังจากการคลิ๊กปุ่ม Microflow ซึ่งมีโอกาสที่จะทำ application down
- ถ้ารู้สึกว่า UI ทำงานผิดพลาด หรือทำงานช้าเมื่อโหลดหน้าจอ ก็น่าจะมีปัญหาเรื่อง UI เป็นหลัก

```
ทุกปัญหาเรื่อง Performance เป็นเรื่องละเอียดอ่อน ซึ่งไม่ได้หมายความว่าจะแก้ปัญหาได้ทุกอย่าง บทความนี้จะช่วยหาปัญหาและวิธีการแก้ปัญหา
```

# UI ช้า
ถ้า User Interface ช้าก็น่า ต้องหาให้ได้ว่าเกิดจาก Microflow ไปเปิด Page หรือเกิดจาก UI ที่มีการแสดงข้อมูลหลาย ๆ อย่าง และสิ่งที่จะบอกว่าได้ว่าเกิดจากอะไรเราจะต้องใช้ Web Developer Tools (Chrome, Firefox)

กรณีตัวอย่าง เช่น รันเทส application โดย retrieve ข้อมูลด้วย XPath ทั้งหมด 26 ครั้ง สำหรับหน้าเดียว คุณก็จะเห็นแต่ละขั้นตอนว่าใช้เวลานานเท่าไรกว่าจะแสดงข้อมูลได้ บางอันที่ retrieve นานกว่าอันอื่น แต่บางครั้งก็อาจจะเป็นที่มีข้อมูลจำนวนมากก็ทำให้เกิดปัญหาได้เช่นกัน

เมื่อบอกได้แล้วว่าสาเหตุเกิดจากอะไรที่ทำให้ UI ทำงานช้า ไม่ว่าจะเกิดจากโหลดหลาย ๆ อย่าง หรือโหลดช้า ให้ดูหัวข้อถัดไป

## โหลดหลาย ๆ อย่าง
ถ้ามีการโหลดหลาย ๆ อย่างในหน้าเดียว ลองดูว่าสามารถลดจำนวนลงได้ไหม นี่เป็นสาเหตุของปัญหาในการโหลดหน้า มีดังนี้
- มีหลาย ๆ Datagrid
- มีหลาย ๆ Dataview
- มีหลาย ๆ Reference selector
- มีหลาย ๆ Tab
- Widget

แต่ละสถานการณ์ไม่เหมือนกัน ต้องลองผิดลองถูกว่าอันไหนมันดีขึ้น อาจจะมีการลบออกแล้วทำให้หน้าโหลดเร็วขึ้น

## โหลดช้า
ถ้าพบว่ามีปัญหาการโหลดช้า ลองหาเครื่องมือที่เข้ามาช่วย ในส่วนนี้เราจะยกตัวอย่างให้ดู

###  Network ช้า
ถ้าข้อมูลน้อยแต่ใช้เวลานาน ให้ติดต่อผู้ดูแลระบบมาช่วยดูในส่วนนี้ ในส่วนนี้เราจะดูแค่ในส่วนของ application เท่านั้น

### การ Retrieve
ถ้าพบว่าการ retrieve ทำให้ทำงานช้า ลองดูตามนี้
- XPath ที่ยาก
- ไม่มี Index
- รวมถึง Security rules

### Microflow
ถ้าเกิดจาก Microflow ดูหัวข้อถัดไป

# Microflow ช้า
ถ้าปัญหาเรื่อง Performance เกิดจาก Microflow คุณควรดูแต่ละ activity ที่ทำให้ทำงานช้า

บางครั้งสิ่งที่จะบอกว่า activity ไหนช้า และ microflow ไหนบ้างทำงานช้า คุณควรจะไล่ดูว่าเป็นที่ Microflow ไหนกันแน่ โดยหาเป็นทีละ step จนกว่าจะเจอจุดที่ทำงานช้า ถ้าพบแล้วก็มาดูขั้นตอนต่อไปในการปรับให้ Optimize แต่ถ้ายังไม่เจอให้ดูด้านล่าง

## Server Monitoring
ในส่วนนี้ขึ้นอยู่กับแต่ละ environment จะมีส่วนให้ดู performance graph หรือ log ให้ใช้งานหรือไม่

## Microflow Debugger
เมื่อบอกได้แล้วว่าหน้าไหนที่ทำงานช้า ก็สามารถหาได้ว่ามี microflow รวมถึง sub-microflow, on-change และ event-handler ด้วย ที่สามารถเรียกผ่านในหน้าจอของคุณได้

ทำการใส่ break point ไปที่ microflow ได้เลย เป็นวิธีที่เร็วที่สุดในการหาจุดที่ทำงานช้า ถ้ายังบอกไม่ได้ว่าเป็นตรงไหนให้ดูหัวข้อถัดไป

## Stamp เวลาที่ Microflow
การ stamp เวลาที่ activity ที่ทำงานช้าใน Microflow และเวลาที่ใช้ในแต่ละจุดที่ทำงาน สามารถทำตามตัวอย่างดังนี้

![file](/uploads/inline_files/image-1590026465805.png)

เซ็ตเวลาเริ่มต้นโดยการ **Create variable** แล้วใส่ค่าเป็นเวลาปัจจุบัน

![file](/uploads/inline_files/image-1590026720108.png)

หลังจากนั้นเพิ่ม **Log message** ไว้ท้ายสุดของ Microflow

![file](/uploads/inline_files/image-1590026914742.png)

เซ็ตค่าเหมือนกับด้านล่าง

![file](/uploads/inline_files/image-1590026945106.png)

นี่เป็นการคำนวณมีหน่วยเป็น milliseconds เมื่อ Microflow เริ่มและสิ้นสุดการทำงาน และแสดงผลไปที่ console เมื่อมีการเรียกการใช้งาน Microflow นี้

เพิ่มตัวคำนวณเวลาไปตามจุดต่าง ๆ จนกว่าจะเจอ Microflow ที่เป็นปัญหา เมื่อเจอจุดที่ทำงานช้าแล้วให้ไปดูหัวข้อ **เพิ่มประสิทธิให้กับ Microflow** จะมีรายละเอียดที่จะทำให้ Microflow ทำงานได้เร็วขึ้น

# เพิ่มประสิทธิภาพให้กับ Microflow
## Retrieve ข้อมูลมูลจาก Database ช้า
มีหลาย ๆ เหตุผลที่ทำให้การ Retrieve ข้อมูลแล้วช้า
- XPath ที่ไม่ดี
- XPath ที่ซับซ้อนใน Security
- ไม่มีการกำหนด Index
- Calculate attribute ที่มีความยาก
- Retrieve ข้อมูลมาทีละจำนวนมาก ๆ

นอกจากนี้ สามารถเพิ่มความสามารถโดยการทำ denormalization ในบางกรณี (จะอธิบายส่วนี้ในบทความต่อ ๆ ไป)

## Commit ข้อมูลลง Database ช้า
การ commit ที่ช้ามีสาเหตุที่พบบ่อย ๆ จาก before-commit หรือ after-commit ลองดูจาก Microflow เหล่านี้ด้วย

ถ้าคุณ commit ข้อมูลมาก ๆ (เช่น 1000 rows) ก็อาจจะเปลี่ยนมาใช้ batching ในการเพิ่มประสิทธิภาพ นอกจากนี้ยังต้องเช็คเรื่องการใช้งาน Refresh in client ด้วย

### Batches
ภาพด้านล่างนี้เป็นตัวอย่างในการ retrieve แบบ batches คุณสามารถทำการ commit ตามนี้ได้เช่นกัน

![file](/uploads/inline_files/image-1590027012978.png)

### Refresh in Client
การ Refresh in client ที่อยู่ใน change หรือ commit เป็นส่วนที่ช่วยในการแสดงข้อมูลให้กับผู้ใช้งาน อย่างไรก็ตามเมื่อมีการ commit ข้อมูลปริมาณมาก ๆ อาจจะทำให้ application คุณช้าลงได้ เพราะเป็นการรวมการเปลี่ยนแปลงข้อมูลเป็น 1000 รายการที่ browser ถ้าเป็นไปได้ก็ควรไม่ทำการ refresh

# Microflow ที่ช้าทั่ว ๆ ไป (บอกไม่ได้ว่าเกิดจาก Activity ไหน)
ถ้า Microflow ของคุณช้าโดยไม่สามารถหาสาเหตุได้ ในหัวข้อนี้จะจะบอกถึงสิ่งที่จะเป็นไปได้

## Commit หลายครั้ง
ถ้าหา Microflow ที่มีการ commit ใน loop คุณสามารถ optimize ได้โดยการสร้าง list แล้ว commit ตามตัวอย่างด้านล่าง


ทุกครั้งที่มีการ commit **Order** สามารถ optimize ได้โดยการ commit นอก loop หลังจากที่ทำการเซ็ตค่าใน loop เรียบร้อยแล้ว โดยการกำหนด **Commit** เป็น **No** ที่ **Change order** หลังจากนั้น commit OrderList ด้านนอก loop 


ในที่สุดก็ช่วยลดการทำงานของ database ลงได้ภายใน Microflow เป็นการเพิ่มประสิทธิภาพได้

## Retrieve หลายครั้ง
ถ้า Microflow มีการ retrieve หลายครั้ง โดยเฉพาะใน loop นี่เป็นสาเหตุที่ทำให้เกิดปัญหาเรื่อง performance การ optimize โดยถ้ามีการ retrieve ด้านนอก loop จะเป็นไปได้ไหม?

![file](/uploads/inline_files/image-1590027077892.png)

นอกจากนี้ ลองดูที่ calculate attribute ที่ entity ของคุณด้วย ซึ่งมันจะทำงานทุกครั้งที่มีการ retrieve ที่ entity เหล่านั้น ไม่ว่าจะใช้หรือไม่ใช้

![file](/uploads/inline_files/image-1590027101288.png)

## Loop โดยไม่จำเป็นหรือ Loop ซ้อน Loop
ถ้าพบว่า Microflow คุณมีข้อมูลที่ต้อง loop เยอะมาก ๆ หรือโดยเฉพาะอย่างยิ่ง loop ซ้อนกัน ทำให้ใช้เวลามากขึ้น ในสถานการณ์แบบนี้อาจจะลองคิดว่า domain model ว่าสามารถทำให้เข้าถึง entity attribute หรือ associate ได้ง่ายขึ้นได้ไหม อาจจะใช้ XPath แทนการค้นหาใน loop

อย่างเช่นเคย ต้องให้แน่ใจว่าการ retrieve และการ commit ใน loop ต้องทำให้น้อยที่สุดเท่าที่จะเป็นไปได้